<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sticker Calendar 2026</title>
  <style>
    :root{
      --bg:#0f1115;
      --panel:#171a21;
      --text:#e8ecf3;
      --muted:#a9b2c3;
      --card: rgba(255,255,255,.04);
      --card2: rgba(255,255,255,.03);
      --shadow: 0 12px 30px rgba(0,0,0,.35);

      --pink:#ff6fae;
      --yellow:#ffd55a;
      --blue:#62c7ff;
      --ring: rgba(255,255,255,.16);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: radial-gradient(1100px 700px at 20% 0%, #1a2040 0%, var(--bg) 60%);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
      background: rgba(15,17,21,.65);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .wrap{
      max-width: 820px;
      margin: 0 auto;
      padding: 14px 14px 40px;
    }

    .titleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 0 8px;
    }

    .monthNav{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .navBtn{
      width: 36px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 16px;
      line-height: 1;
    }
    .navBtn:active{ transform: translateY(1px); }
    .navBtn[disabled]{ opacity: .35; cursor: default; transform:none; }

    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .rightBar{
      display:flex;
      gap:8px;
      align-items:center;
      flex: 0 0 auto;
    }

    /* ハンバーガー */
    .hamburger{
      width: 38px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 4px;
      cursor:pointer;
    }
    .hamburger span{
      width: 16px;
      height: 2px;
      background: rgba(255,255,255,.75);
      border-radius: 2px;
    }
    .hamburger:active{ transform: translateY(1px); }

    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 10px;
      padding: 10px 10px 0;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    .grid{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px;
      margin-top: 8px;
      box-shadow: var(--shadow);
    }

    .days{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 10px 0 0;
    }

    /* カレンダーセル：日付 + 目標(太字) + スタンプ */
    .cell{
      position: relative;
      height: 76px; /* 目標表示分だけ少し増やす */
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.06);
      background: var(--card2);
      padding: 8px;
      cursor: pointer;
      overflow: hidden;
      user-select: none;
    }
    .cell.empty{
      opacity: .25;
      cursor: default;
    }
    .cell.selected{
      outline: 2px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.055);
    }

    .daynum{
      font-size: 12px;
      color: var(--muted);
      line-height: 1;
    }

    .goalPreview{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .01em;
      color: rgba(232,236,243,.92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 28px; /* 右下の丸と干渉しない */
    }
    .goalPreview.empty{
      opacity: .25;
      font-weight: 600;
    }

    /* カレンダーのスタンプ */
    .dot{
      position:absolute;
      right: 8px;
      bottom: 8px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 2px solid var(--ring);
      background: transparent;
      cursor: pointer;
      transition: transform .08s ease;
    }
    .dot:active{ transform: scale(.95); }
    .dot.filled{ border-color: rgba(255,255,255,.18); box-shadow: 0 8px 18px rgba(0,0,0,.25); }
    .dot.pink{ background: var(--pink); }
    .dot.yellow{ background: var(--yellow); }
    .dot.blue{ background: var(--blue); }

    /* ===== 色選択ポップアップ ===== */
    .picker{
      position: fixed;
      z-index: 9999;
      display: none;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(23,26,33,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .picker.show{ display:flex; }

    .pick{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      cursor: pointer;
      transition: transform .08s ease;
    }
    .pick:active{ transform: translateY(1px) scale(.98); }
    .pick.pink{ background: var(--pink); }
    .pick.yellow{ background: var(--yellow); }
    .pick.blue{ background: var(--blue); }

    .caret{
      position: fixed;
      z-index: 9998;
      width: 10px; height: 10px;
      background: rgba(23,26,33,.92);
      border-left: 1px solid rgba(255,255,255,.12);
      border-top: 1px solid rgba(255,255,255,.12);
      transform: rotate(45deg);
      display:none;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .caret.show{ display:block; }

    /* ===== メニュー ===== */
    .menuOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(4px);
      display:none;
      z-index: 50;
    }
    .menuOverlay.show{ display:block; }

    .menuSheet{
      position: fixed;
      right: 14px;
      top: 74px;
      width: min(340px, calc(100vw - 28px));
      background: rgba(23,26,33,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      padding: 10px;
      display:none;
      z-index: 60;
    }
    .menuSheet.show{ display:block; }

    .menuItem{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .menuItem:last-child{ margin-bottom:0; }
    .badge{ font-size: 12px; color: var(--muted); }

    /* ===== buttons ===== */
    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      min-width: 90px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.danger{
      border-color: rgba(255,140,140,.25);
      background: rgba(255,120,120,.12);
    }

    /* ===== diary ===== */
    .diary{
      margin-top: 12px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      display:none;
    }
    .diary.show{ display:block; }

    .diaryHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .diaryHeadLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .diaryStamp{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid var(--ring);
      background: transparent;
      flex: 0 0 auto;
      cursor: pointer;
      transition: transform .08s ease;
    }
    .diaryStamp:active{ transform: scale(.95); }
    .diaryStamp.filled{ border-color: rgba(255,255,255,.18); box-shadow: 0 8px 18px rgba(0,0,0,.25); }
    .diaryStamp.pink{ background: var(--pink); }
    .diaryStamp.yellow{ background: var(--yellow); }
    .diaryStamp.blue{ background: var(--blue); }

    .diaryLabel{ font-size: 12px; color: var(--muted); }
    .diaryDate{ font-size: 16px; font-weight: 700; letter-spacing: .02em; margin-top: 2px; }

    .iconBtn{
      width: 38px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn svg{ width: 18px; height: 18px; opacity:.9; }

    .inlineConfirm{
      display:none;
      margin: 6px 0 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .inlineConfirm.show{ display:block; }
    .inlineConfirmMsg{
      font-size: 13px;
      color: rgba(232,236,243,.95);
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .inlineConfirmBtns{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
    }

    .section{
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .section:first-of-type{
      margin-top: 6px;
      padding-top: 0;
      border-top: none;
    }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .sectionTitle{ font-size: 12px; color: var(--muted); }

    input.goal{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    input.goal:focus{ border-color: rgba(255,255,255,.22); }

    .todoList{ display:flex; flex-direction:column; gap: 8px; }
    .todoRow{
      display:flex;
      align-items:center;
      gap: 10px;
      position: relative;
      padding-right: 34px;
    }
    .todoRow input[type="checkbox"]{
      width: 18px; height: 18px;
      accent-color: rgba(255,255,255,.65);
      flex: 0 0 auto;
    }
    .todoRow input.todoText{
      flex: 1 1 auto;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    .todoRow input.todoText:focus{ border-color: rgba(255,255,255,.22); }

    .todoDel{
      position:absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      display:none;
      cursor:pointer;
    }
    .todoRow.showDel .todoDel{ display:block; }

    textarea.memo{
      width: 100%;
      min-height: 140px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      resize: vertical;
      line-height: 1.5;
      font-size: 14px;
    }
    textarea.memo:focus{ border-color: rgba(255,255,255,.22); }

    .hint{ color: var(--muted); font-size: 12px; margin-top: 10px; line-height: 1.6; }

    /* ===== list ===== */
    .list{
      margin-top: 12px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      display:none;
    }
    .list.show{ display:block; }

    .listHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .listTitle{ font-size: 14px; color: var(--muted); }

    .listItem{
      border-top: 1px solid rgba(255,255,255,.06);
      padding: 10px 0;
    }
    .listItem:first-of-type{ border-top: none; padding-top: 0; }

    .listItemHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .listLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .miniStamp{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid var(--ring);
      background: transparent;
      flex: 0 0 auto;
    }
    .miniStamp.filled{ border-color: rgba(255,255,255,.18); }
    .miniStamp.pink{ background: var(--pink); }
    .miniStamp.yellow{ background: var(--yellow); }
    .miniStamp.blue{ background: var(--blue); }

    .listDate{
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
    }

    .preview{
      color: rgba(232,236,243,.85);
      font-size: 13px;
      line-height: 1.5;
      opacity: .92;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .muted{ color: var(--muted); }

    /* ===== data (new structure) ===== */
    .data{
      margin-top: 12px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      display:none;
    }
    .data.show{ display:block; }

    .majorTitle{
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0 8px;
      letter-spacing: .02em;
    }

    .kvRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 0;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .kvRow:first-of-type{ border-top:none; padding-top:0; }

    .kvLeft{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .kvLabel{
      font-size: 13px;
      color: rgba(232,236,243,.92);
    }
    .kvValueBig{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .02em;
      line-height: 1.2;
      white-space: nowrap;
    }

    .toggleBtn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 13px;
      cursor:pointer;
      white-space: nowrap;
    }
    .toggleBtn:active{ transform: translateY(1px); }

    .monthBreakdown{
      display:none;
      margin-top: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
    }
    .monthBreakdown.show{ display:block; }

    .monthLine{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 6px 0;
      border-top: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      color: rgba(232,236,243,.92);
    }
    .monthLine:first-child{ border-top:none; padding-top:0; }
    .monthLine span:last-child{ color: var(--muted); }

    .minorNote{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      margin-top: 8px;
    }

    .row{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 0;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .row:first-of-type{ border-top:none; padding-top:0; }
    .rowLabel{
      min-width: 220px;
      font-size: 13px;
      color: rgba(232,236,243,.92);
    }
    .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    select{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-size: 13px;
    }
    input[type="file"]{
      color: var(--muted);
      font-size: 12px;
    }

    .divider{
      margin: 14px 0;
      border-top: 1px solid rgba(255,255,255,.08);
    }

    @media (max-width: 360px){
      .cell{ height: 72px; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="titleRow">
      <div style="min-width:0;">
        <div class="monthNav">
          <button class="navBtn" id="prevMonth" type="button" aria-label="前の月">＜</button>
          <div style="min-width:0;">
            <h1 id="monthTitle">2026年1月</h1>
            <div class="sub">丸タップで色 / 日付タップで日記</div>
          </div>
          <button class="navBtn" id="nextMonth" type="button" aria-label="次の月">＞</button>
        </div>
      </div>

      <div class="rightBar">
        <button class="hamburger" id="hamburger" type="button" aria-label="メニュー">
          <span></span><span></span><span></span>
        </button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="dow">
    <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
  </div>

  <section class="grid" aria-label="カレンダー">
    <div class="days" id="days"></div>
  </section>

  <!-- 単日日記 -->
  <section class="diary" id="diary">
    <div class="diaryHead">
      <div class="diaryHeadLeft">
        <div class="diaryStamp" id="diaryStamp" aria-label="その日のスタンプ（クリックで変更）"></div>
        <div>
          <div class="diaryLabel">日記</div>
          <div class="diaryDate" id="diaryDate">----</div>
        </div>
      </div>

      <button class="iconBtn" id="deleteDay" type="button" aria-label="この日を削除">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M9 3h6m-8 4h10m-9 0 1 16h6l1-16M10 7v12m4-12v12"
                stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="inlineConfirm" id="inlineConfirm">
      <div class="inlineConfirmMsg" id="inlineConfirmMsg">この日のデータを削除しますか？</div>
      <div class="inlineConfirmBtns">
        <button class="btn" id="inlineNo" type="button">いいえ</button>
        <button class="btn danger" id="inlineYes" type="button">はい</button>
      </div>
    </div>

    <div class="section">
      <div class="sectionHead">
        <div class="sectionTitle">① 今日の目標</div>
      </div>
      <input class="goal" id="goalInput" type="text" placeholder="1行で入力（自動保存）" />
    </div>

    <div class="section">
      <div class="sectionHead">
        <div class="sectionTitle">② TODO</div>
        <button class="btn" id="addTodo" type="button" style="padding:8px 10px; border-radius:12px;">＋</button>
      </div>
      <div class="todoList" id="todoList"></div>
    </div>

    <div class="section">
      <div class="sectionHead">
        <div class="sectionTitle">③ 自由メモ</div>
      </div>
      <textarea class="memo" id="memoInput" placeholder="数行メモ（自動保存）"></textarea>
    </div>

    <div class="hint">日付切替で内容が切り替わる。</div>
  </section>

  <!-- 日記一覧 -->
  <section class="list" id="list">
    <div class="listHead">
      <div class="listTitle">日記一覧（1日〜月末）</div>
      <div class="badge" id="listBadge"></div>
    </div>
    <div id="listBody"></div>
  </section>

  <!-- データ管理（新構成） -->
  <section class="data" id="data">

    <div class="majorTitle">▼ユーザーデータ</div>

    <div class="kvRow">
      <div class="kvLeft">
        <div class="kvLabel">2026年記録日数</div>
        <div class="kvValueBig" id="yearTotal">0日</div>
      </div>
      <button class="toggleBtn" id="toggleBreakdown" type="button">▼詳細表示</button>
    </div>

    <div class="monthBreakdown" id="monthBreakdown"></div>

    <div class="divider"></div>

    <div class="majorTitle">▼データ管理</div>

    <div class="row">
      <div class="rowLabel">選択期間内のデータ一括書き出し</div>
      <div class="controls">
        <select id="bulkFrom" aria-label="開始月">
          <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
          <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
          <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
          <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
        </select>
        <span style="color:var(--muted); font-size:13px;">〜</span>
        <select id="bulkTo" aria-label="終了月">
          <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
          <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
          <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
          <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
        </select>
        <button class="btn" id="bulkExportBtn" type="button">一括書き出し</button>
      </div>
    </div>

    <div class="row">
      <div class="rowLabel">データ読み込み（ある月のみ上書き）</div>
      <div class="controls">
        <input type="file" id="bulkImportFile" accept="application/json,.json" />
        <button class="btn" id="bulkImportBtn" type="button">一括読み込み</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="majorTitle">▼データリセット</div>

    <div class="row">
      <div class="rowLabel">全データリセット</div>
      <div class="controls">
        <button class="btn danger" id="resetAllBtn" type="button">全月を削除</button>
      </div>
    </div>

    <div class="minorNote">
      ※全データリセットは、2026年の全月データが削除される。
    </div>
  </section>
</main>

<!-- 色選択ポップアップ -->
<div class="picker" id="picker" role="dialog" aria-label="色を選ぶ">
  <button class="pick pink" data-color="pink" type="button" aria-label="ピンク"></button>
  <button class="pick yellow" data-color="yellow" type="button" aria-label="黄色"></button>
  <button class="pick blue" data-color="blue" type="button" aria-label="水色"></button>
</div>
<div class="caret" id="caret"></div>

<!-- メニュー -->
<div class="menuOverlay" id="menuOverlay"></div>
<div class="menuSheet" id="menuSheet" role="dialog" aria-label="メニュー">
  <button class="menuItem" id="menuCalendar" type="button">
    <span>カレンダー</span><span class="badge">単日日記</span>
  </button>
  <button class="menuItem" id="menuList" type="button">
    <span>日記一覧</span><span class="badge">1〜月末</span>
  </button>
  <button class="menuItem" id="menuData" type="button">
    <span>データ管理</span><span class="badge">書き出し/読込</span>
  </button>
</div>

<script>
(() => {
  const YEAR = 2026;
  const MIN_MONTH = 1;
  const MAX_MONTH = 12;
  const COLORS = ["pink","yellow","blue"];
  const APP_VERSION = "1.2.0";

  // elements
  const monthTitleEl = document.getElementById("monthTitle");
  const prevMonthBtn = document.getElementById("prevMonth");
  const nextMonthBtn = document.getElementById("nextMonth");
  const daysEl = document.getElementById("days");

  const diaryEl = document.getElementById("diary");
  const diaryDateEl = document.getElementById("diaryDate");
  const diaryStampEl = document.getElementById("diaryStamp");
  const deleteDayBtn = document.getElementById("deleteDay");
  const goalInput = document.getElementById("goalInput");
  const memoInput = document.getElementById("memoInput");
  const todoListEl = document.getElementById("todoList");
  const addTodoBtn = document.getElementById("addTodo");

  const inlineConfirm = document.getElementById("inlineConfirm");
  const inlineYes = document.getElementById("inlineYes");
  const inlineNo = document.getElementById("inlineNo");

  const listEl = document.getElementById("list");
  const listBodyEl = document.getElementById("listBody");
  const listBadgeEl = document.getElementById("listBadge");

  const dataEl = document.getElementById("data");
  const yearTotalEl = document.getElementById("yearTotal");
  const toggleBreakdownBtn = document.getElementById("toggleBreakdown");
  const monthBreakdownEl = document.getElementById("monthBreakdown");

  const bulkFrom = document.getElementById("bulkFrom");
  const bulkTo = document.getElementById("bulkTo");
  const bulkExportBtn = document.getElementById("bulkExportBtn");
  const bulkImportFile = document.getElementById("bulkImportFile");
  const bulkImportBtn = document.getElementById("bulkImportBtn");
  const resetAllBtn = document.getElementById("resetAllBtn");

  const pickerEl = document.getElementById("picker");
  const caretEl = document.getElementById("caret");

  const hamburgerBtn = document.getElementById("hamburger");
  const menuOverlay = document.getElementById("menuOverlay");
  const menuSheet = document.getElementById("menuSheet");
  const menuCalendarBtn = document.getElementById("menuCalendar");
  const menuListBtn = document.getElementById("menuList");
  const menuDataBtn = document.getElementById("menuData");

  // storage
  function storageKey(month){
    return `sticker-cal:${YEAR}-${String(month).padStart(2,'0')}`;
  }
  function loadStateForMonth(month){
    try { return JSON.parse(localStorage.getItem(storageKey(month)) || "{}"); }
    catch { return {}; }
  }
  function saveStateForMonth(month, obj){
    localStorage.setItem(storageKey(month), JSON.stringify(obj));
  }

  // state
  let currentMonth = 1;
  let state = loadStateForMonth(currentMonth);
  let selectedDate = null;
  let pickerDate = null;
  let pickerSource = null;
  let viewMode = "calendar"; // calendar | list | data
  let breakdownOpen = false;

  function uid(){
    return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
  }
  function daysInMonthOf(month){
    return new Date(YEAR, month, 0).getDate();
  }
  function ymd(month, day){
    return `${YEAR}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  }
  function ensureDay(dateKey){
    if (!state[dateKey]) state[dateKey] = { stamp: null, diary: { goal:"", todos: [], memo:"" } };
    if (!state[dateKey].diary) state[dateKey].diary = { goal:"", todos: [], memo:"" };

    const d = state[dateKey].diary;
    if (typeof d.goal !== "string") d.goal = "";
    if (!Array.isArray(d.todos)) d.todos = [];
    if (typeof d.memo !== "string") d.memo = "";

    if (d.todos.length === 0){
      d.todos = [
        { id: uid(), done:false, text:"" },
        { id: uid(), done:false, text:"" },
        { id: uid(), done:false, text:"" },
      ];
    } else {
      d.todos = d.todos.map(t => ({
        id: (t && typeof t.id === "string") ? t.id : uid(),
        done: !!(t && t.done),
        text: (t && typeof t.text === "string") ? t.text : ""
      }));
    }
  }
  function persist(){
    saveStateForMonth(currentMonth, state);
  }

  // helpers: goal preview (10 chars, with …)
  function goalPreviewText(goal){
    const s = (goal || "").trim();
    if (!s) return "";
    // 10文字目以降は省略
    return (s.length > 10) ? (s.slice(0,10) + "…") : s;
  }

  // view
  function setView(mode){
    viewMode = mode;
    diaryEl.classList.remove("show");
    listEl.classList.remove("show");
    dataEl.classList.remove("show");
    hideInlineConfirm();

    if (mode === "calendar"){
      if (selectedDate) diaryEl.classList.add("show");
    } else if (mode === "list"){
      listEl.classList.add("show");
      renderList();
    } else if (mode === "data"){
      dataEl.classList.add("show");
      bulkFrom.value = String(currentMonth);
      bulkTo.value = String(currentMonth);
      renderYearStats();
    }
  }

  // month header
  function updateMonthHeader(){
    monthTitleEl.textContent = `${YEAR}年${currentMonth}月`;
    prevMonthBtn.disabled = currentMonth <= MIN_MONTH;
    nextMonthBtn.disabled = currentMonth >= MAX_MONTH;
  }
  function changeMonth(nextMonth){
    if (nextMonth < MIN_MONTH || nextMonth > MAX_MONTH) return;
    hidePicker();
    hideInlineConfirm();
    selectedDate = null;
    setView("calendar");

    currentMonth = nextMonth;
    state = loadStateForMonth(currentMonth);

    updateMonthHeader();
    renderCalendar();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  prevMonthBtn.addEventListener("click", () => changeMonth(currentMonth - 1));
  nextMonthBtn.addEventListener("click", () => changeMonth(currentMonth + 1));

  // menu
  function closeMenu(){
    menuOverlay.classList.remove("show");
    menuSheet.classList.remove("show");
  }
  function openMenu(){
    menuOverlay.classList.add("show");
    menuSheet.classList.add("show");
  }
  hamburgerBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if (menuSheet.classList.contains("show")) closeMenu();
    else openMenu();
  });
  menuOverlay.addEventListener("click", closeMenu);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeMenu(); });

  menuCalendarBtn.addEventListener("click", () => { closeMenu(); setView("calendar"); });
  menuListBtn.addEventListener("click", () => { closeMenu(); setView("list"); });
  menuDataBtn.addEventListener("click", () => { closeMenu(); setView("data"); });

  // picker
  function hidePicker(){
    pickerEl.classList.remove("show");
    caretEl.classList.remove("show");
    pickerDate = null;
    pickerSource = null;
  }
  function showPickerNear(el, dateKey, source){
    pickerDate = dateKey;
    pickerSource = source;

    pickerEl.classList.add("show");
    caretEl.classList.add("show");

    const r = el.getBoundingClientRect();
    const pr = pickerEl.getBoundingClientRect();
    const caretSize = 10;

    let left = r.left + r.width/2 - pr.width/2;
    left = Math.max(8, Math.min(left, window.innerWidth - pr.width - 8));

    let top = r.top - pr.height - 12;
    let caretTop = r.top - caretSize/2 - 6;

    if (top < 8){
      top = r.bottom + 12;
      caretTop = r.bottom + 6;
    }

    pickerEl.style.left = `${left}px`;
    pickerEl.style.top = `${top}px`;

    const caretLeft = r.left + r.width/2 - caretSize/2;
    caretEl.style.left = `${caretLeft}px`;
    caretEl.style.top = `${caretTop}px`;
  }

  function setDiaryStampFromDate(dateKey){
    ensureDay(dateKey);
    const stamp = state[dateKey].stamp;
    diaryStampEl.className = "diaryStamp";
    if (COLORS.includes(stamp)) diaryStampEl.classList.add("filled", stamp);
  }
  function setMiniStampClass(el, stamp){
    el.className = "miniStamp";
    if (COLORS.includes(stamp)) el.classList.add("filled", stamp);
  }

  function applyStamp(dateKey, colorOrNull){
    ensureDay(dateKey);
    state[dateKey].stamp = colorOrNull;
    persist();

    renderCalendar();

    if (selectedDate === dateKey){
      setDiaryStampFromDate(dateKey);
    }
    if (viewMode === "list") renderList();
    if (viewMode === "data") renderYearStats(); // 記録日数に影響するので更新
  }

  pickerEl.addEventListener("click", (e) => {
    const b = e.target.closest("button[data-color]");
    if (!b || !pickerDate) return;

    const dateKey = pickerDate; // 退避
    const color = b.getAttribute("data-color");

    ensureDay(dateKey);
    const next = (state[dateKey].stamp === color) ? null : color;

    hidePicker();
    applyStamp(dateKey, next);
  });

  document.addEventListener("pointerdown", (e) => {
    const inPicker = e.target.closest("#picker");
    const isDot = e.target.closest(".dot") || e.target.closest("#diaryStamp");
    if (!inPicker && !isDot) hidePicker();
  });

  // calendar render (with goal preview)
  function renderCalendar(){
    daysEl.innerHTML = "";
    const first = new Date(YEAR, currentMonth - 1, 1);
    const last = new Date(YEAR, currentMonth, 0);
    const firstDow = first.getDay();
    const dim = last.getDate();
    const totalCells = 42;

    for (let i=0; i<totalCells; i++){
      const day = i - firstDow + 1;
      const inMonth = day >= 1 && day <= dim;

      const cell = document.createElement("div");
      cell.className = "cell" + (inMonth ? "" : " empty");

      const num = document.createElement("div");
      num.className = "daynum";
      num.textContent = inMonth ? String(day) : "";
      cell.appendChild(num);

      if (inMonth){
        const key = ymd(currentMonth, day);
        ensureDay(key);

        if (key === selectedDate) cell.classList.add("selected");

        // goal preview
        const g = (state[key].diary && typeof state[key].diary.goal === "string") ? state[key].diary.goal : "";
        const pv = goalPreviewText(g);
        const pvEl = document.createElement("div");
        pvEl.className = "goalPreview" + (pv ? "" : " empty");
        pvEl.textContent = pv || "—";
        cell.appendChild(pvEl);

        cell.addEventListener("click", () => {
          hidePicker();
          openDiary(key);
        });

        const dot = document.createElement("button");
        dot.type = "button";
        dot.className = "dot";
        dot.setAttribute("aria-label", `${key} スタンプ`);

        const stamp = state[key].stamp;
        if (COLORS.includes(stamp)) dot.classList.add("filled", stamp);

        dot.addEventListener("click", (e) => {
          e.stopPropagation();
          if (pickerEl.classList.contains("show") && pickerDate === key && pickerSource === "calendar"){
            hidePicker();
          } else {
            showPickerNear(dot, key, "calendar");
          }
        });

        cell.appendChild(dot);
      }

      daysEl.appendChild(cell);
    }
  }

  // diary
  function openDiary(dateKey){
    selectedDate = dateKey;
    ensureDay(dateKey);
    persist();

    setView("calendar");
    diaryEl.classList.add("show");
    diaryDateEl.textContent = dateKey;
    setDiaryStampFromDate(dateKey);

    const d = state[dateKey].diary;
    goalInput.value = d.goal || "";
    memoInput.value = d.memo || "";
    renderTodos(dateKey);

    renderCalendar();
    hideInlineConfirm();
  }

  function renderTodos(dateKey){
    ensureDay(dateKey);
    const todos = state[dateKey].diary.todos;

    todoListEl.innerHTML = "";
    for (const t of todos){
      const row = document.createElement("div");
      row.className = "todoRow";

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = !!t.done;

      const txt = document.createElement("input");
      txt.type = "text";
      txt.className = "todoText";
      txt.value = t.text || "";
      txt.placeholder = "TODO";

      const del = document.createElement("button");
      del.type = "button";
      del.className = "todoDel";
      del.textContent = "－";
      del.setAttribute("aria-label", "この行を削除");

      txt.addEventListener("focus", () => row.classList.add("showDel"));
      txt.addEventListener("blur", () => setTimeout(() => row.classList.remove("showDel"), 120));

      chk.addEventListener("change", () => {
        if (!selectedDate) return;
        const dd = state[selectedDate].diary;
        const item = dd.todos.find(x => x.id === t.id);
        if (!item) return;
        item.done = chk.checked;
        persist();
        if (viewMode === "list") renderList();
      });

      txt.addEventListener("input", () => {
        if (!selectedDate) return;
        const dd = state[selectedDate].diary;
        const item = dd.todos.find(x => x.id === t.id);
        if (!item) return;
        item.text = txt.value || "";
        persist();
        if (viewMode === "list") renderList();
      });

      del.addEventListener("click", () => {
        if (!selectedDate) return;
        const dd = state[selectedDate].diary;
        dd.todos = dd.todos.filter(x => x.id !== t.id);
        if (dd.todos.length === 0){
          dd.todos = [{ id: uid(), done:false, text:"" }];
        }
        persist();
        renderTodos(selectedDate);
        if (viewMode === "list") renderList();
      });

      row.appendChild(chk);
      row.appendChild(txt);
      row.appendChild(del);
      todoListEl.appendChild(row);
    }
  }

  goalInput.addEventListener("input", () => {
    if (!selectedDate) return;
    ensureDay(selectedDate);
    state[selectedDate].diary.goal = goalInput.value || "";
    persist();
    renderCalendar();           // ★カレンダーに即反映
    if (viewMode === "list") renderList();
    if (viewMode === "data") renderYearStats();
  });

  memoInput.addEventListener("input", () => {
    if (!selectedDate) return;
    ensureDay(selectedDate);
    state[selectedDate].diary.memo = memoInput.value || "";
    persist();
    if (viewMode === "list") renderList();
    if (viewMode === "data") renderYearStats();
  });

  addTodoBtn.addEventListener("click", () => {
    if (!selectedDate) return;
    ensureDay(selectedDate);
    state[selectedDate].diary.todos.push({ id: uid(), done:false, text:"" });
    persist();
    renderTodos(selectedDate);
    if (viewMode === "list") renderList();
    todoListEl.lastElementChild?.querySelector("input.todoText")?.focus();
  });

  diaryStampEl.addEventListener("click", (e) => {
    if (!selectedDate) return;
    e.stopPropagation();
    if (pickerEl.classList.contains("show") && pickerDate === selectedDate && pickerSource === "diary"){
      hidePicker();
    } else {
      showPickerNear(diaryStampEl, selectedDate, "diary");
    }
  });

  // inline confirm delete-day
  function showInlineConfirm(){
    inlineConfirm.classList.add("show");
  }
  function hideInlineConfirm(){
    inlineConfirm.classList.remove("show");
  }
  deleteDayBtn.addEventListener("click", () => {
    if (!selectedDate) return;
    if (inlineConfirm.classList.contains("show")) hideInlineConfirm();
    else showInlineConfirm();
  });
  inlineNo.addEventListener("click", hideInlineConfirm);
  inlineYes.addEventListener("click", () => {
    if (!selectedDate) return;
    const key = selectedDate;
    delete state[key];
    persist();
    selectedDate = null;
    diaryEl.classList.remove("show");
    hideInlineConfirm();
    renderCalendar();
    if (viewMode === "list") renderList();
    if (viewMode === "data") renderYearStats();
  });

  // list
  function escapePreview(s){ return (s || "").slice(0, 160); }
  function renderList(){
    const dim = daysInMonthOf(currentMonth);
    let filledCount = 0;
    listBodyEl.innerHTML = "";

    for (let day=1; day<=dim; day++){
      const key = ymd(currentMonth, day);
      ensureDay(key);

      const item = document.createElement("div");
      item.className = "listItem";

      const head = document.createElement("div");
      head.className = "listItemHead";

      const left = document.createElement("div");
      left.className = "listLeft";

      const stamp = document.createElement("div");
      setMiniStampClass(stamp, state[key].stamp);

      const date = document.createElement("div");
      date.className = "listDate";
      date.textContent = key;

      left.appendChild(stamp);
      left.appendChild(date);

      const editBtn = document.createElement("button");
      editBtn.className = "btn";
      editBtn.type = "button";
      editBtn.textContent = "編集";
      editBtn.addEventListener("click", () => {
        openDiary(key);
        setView("calendar");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      head.appendChild(left);
      head.appendChild(editBtn);

      const preview = document.createElement("div");
      const d = state[key].diary;

      const hasAny =
        (state[key].stamp) ||
        (d.goal && d.goal.trim()) ||
        (d.memo && d.memo.trim()) ||
        (d.todos && d.todos.some(t => (t.text||"").trim() || t.done));

      if (hasAny) filledCount++;

      const todoLines = (d.todos || [])
        .filter(t => (t.text||"").trim() || t.done)
        .slice(0, 3)
        .map(t => `${t.done ? "☑" : "☐"} ${t.text || ""}`.trim())
        .join("\n");

      const parts = [];
      if (d.goal && d.goal.trim()) parts.push(`目標：${escapePreview(d.goal.trim())}`);
      if (todoLines) parts.push(todoLines);
      if (d.memo && d.memo.trim()) parts.push(escapePreview(d.memo.trim()));

      preview.className = "preview" + (parts.length ? "" : " muted");
      preview.textContent = parts.length ? parts.join("\n") : "（未記入）";

      item.appendChild(head);
      item.appendChild(preview);
      listBodyEl.appendChild(item);
    }

    listBadgeEl.textContent = `${filledCount}/${dim} 日 記入あり`;
  }

  // stats: recorded days (per month + total)
  function monthState(month){
    return (month === currentMonth) ? state : loadStateForMonth(month);
  }
  function countRecordedDaysForMonth(month){
    const dim = daysInMonthOf(month);
    const st = monthState(month);
    let used = 0;
    for (let day=1; day<=dim; day++){
      const key = ymd(month, day);
      const it = st[key];
      if (!it) continue;
      const d = it.diary || {};
      const hasAny =
        (it.stamp) ||
        (d.goal && d.goal.trim()) ||
        (d.memo && d.memo.trim()) ||
        (Array.isArray(d.todos) && d.todos.some(t => (t.text||"").trim() || t.done));
      if (hasAny) used++;
    }
    return { used, dim };
  }

  function renderYearStats(){
    let total = 0;
    const monthLines = [];
    for (let m=MIN_MONTH; m<=MAX_MONTH; m++){
      const { used } = countRecordedDaysForMonth(m);
      total += used;
      monthLines.push({ m, used });
    }

    yearTotalEl.textContent = `${total}日`;

    // breakdown
    monthBreakdownEl.innerHTML = "";
    for (const x of monthLines){
      const line = document.createElement("div");
      line.className = "monthLine";
      const left = document.createElement("span");
      left.textContent = `${x.m}月`;
      const right = document.createElement("span");
      right.textContent = `${x.used}日`;
      line.appendChild(left);
      line.appendChild(right);
      monthBreakdownEl.appendChild(line);
    }

    if (breakdownOpen) monthBreakdownEl.classList.add("show");
    else monthBreakdownEl.classList.remove("show");
  }

  toggleBreakdownBtn.addEventListener("click", () => {
    breakdownOpen = !breakdownOpen;
    toggleBreakdownBtn.textContent = breakdownOpen ? "▲詳細を閉じる" : "▼詳細表示";
    renderYearStats();
  });

  // bulk export/import
  function clampRange(a,b){
    const from = Math.max(MIN_MONTH, Math.min(MAX_MONTH, a));
    const to = Math.max(MIN_MONTH, Math.min(MAX_MONTH, b));
    return (from <= to) ? { from, to } : { from: to, to: from };
  }

  bulkExportBtn.addEventListener("click", () => {
    const r = clampRange(Number(bulkFrom.value), Number(bulkTo.value));
    const months = {};
    for (let m=r.from; m<=r.to; m++){
      months[String(m).padStart(2,'0')] = loadStateForMonth(m);
    }

    const payload = {
      app: "StickerCalendar",
      version: APP_VERSION,
      type: "bulk",
      year: YEAR,
      fromMonth: r.from,
      toMonth: r.to,
      exportedAt: new Date().toISOString(),
      months
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `sticker-calendar-${YEAR}-${String(r.from).padStart(2,'0')}-${String(r.to).padStart(2,'0')}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  });

  bulkImportBtn.addEventListener("click", async () => {
    const file = bulkImportFile.files && bulkImportFile.files[0];
    if (!file) return;

    let text = "";
    try { text = await file.text(); } catch { return; }

    let payload = null;
    try { payload = JSON.parse(text); } catch { return; }

    const monthsObj = payload?.months && typeof payload.months === "object" ? payload.months : null;
    if (!monthsObj) return;

    const ok = window.confirm("データ読み込みを実行しますか？\n（データがある月のみ上書きされます）");
    if (!ok) return;

    for (let m=MIN_MONTH; m<=MAX_MONTH; m++){
      const key = String(m).padStart(2,'0');
      if (Object.prototype.hasOwnProperty.call(monthsObj, key)){
        const incoming = monthsObj[key];
        if (incoming && typeof incoming === "object"){
          saveStateForMonth(m, incoming);
        }
      }
    }

    // refresh current month
    state = loadStateForMonth(currentMonth);
    selectedDate = null;
    diaryEl.classList.remove("show");
    hidePicker();
    hideInlineConfirm();
    renderCalendar();
    if (viewMode === "list") renderList();
    if (viewMode === "data") renderYearStats();
  });

  // reset all
  resetAllBtn.addEventListener("click", () => {
    const ok = window.confirm("本当に削除しますか？\n（全ての月データが削除されます。）");
    if (!ok) return;

    for (let m=MIN_MONTH; m<=MAX_MONTH; m++){
      localStorage.removeItem(storageKey(m));
    }

    state = loadStateForMonth(currentMonth);
    selectedDate = null;
    diaryEl.classList.remove("show");
    hidePicker();
    hideInlineConfirm();
    renderCalendar();
    if (viewMode === "list") renderList();
    if (viewMode === "data") renderYearStats();
  });

  // init
  updateMonthHeader();
  renderCalendar();
})();
</script>
</body>
</html>
