<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sticker Calendar 2026-01</title>
  <style>
    :root{
      --bg:#0f1115;
      --panel:#171a21;
      --text:#e8ecf3;
      --muted:#a9b2c3;
      --card: rgba(255,255,255,.04);
      --card2: rgba(255,255,255,.03);
      --line: rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);

      --pink:#ff6fae;
      --yellow:#ffd55a;
      --blue:#62c7ff;
      --ring: rgba(255,255,255,.16);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: radial-gradient(1100px 700px at 20% 0%, #1a2040 0%, var(--bg) 60%);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(15,17,21,.65);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .wrap{
      max-width: 600px;
      margin: 0 auto;
      padding: 14px 14px 40px;
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 0 8px;
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .02em;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    button.small{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    button.small:active{ transform: translateY(1px); }

    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 10px;
      padding: 10px 10px 0;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    .grid{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px;
      margin-top: 8px;
      box-shadow: var(--shadow);
    }

    .days{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 10px 0 0;
    }

    .cell{
      position: relative;
      height: 64px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.06);
      background: var(--card2);
      padding: 8px;
      cursor: pointer;
      overflow: hidden;
      user-select: none;
    }
    .cell.empty{
      opacity: .25;
      cursor: default;
    }
    .cell.selected{
      outline: 2px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.055);
    }

    .daynum{
      font-size: 12px;
      color: var(--muted);
      line-height: 1;
    }

    /* カレンダーのスタンプ */
    .dot{
      position:absolute;
      right: 8px;
      bottom: 8px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 2px solid var(--ring);
      background: transparent;
      cursor: pointer;
      transition: transform .08s ease;
    }
    .dot:active{ transform: scale(.95); }
    .dot.filled{ border-color: rgba(255,255,255,.18); box-shadow: 0 8px 18px rgba(0,0,0,.25); }
    .dot.pink{ background: var(--pink); }
    .dot.yellow{ background: var(--yellow); }
    .dot.blue{ background: var(--blue); }

    /* ===== 色選択ポップアップ（枠外・固定） ===== */
    .picker{
      position: fixed;
      z-index: 9999;
      display: none;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(23,26,33,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .picker.show{ display:flex; }

    .pick{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      cursor: pointer;
      transition: transform .08s ease;
    }
    .pick:active{ transform: translateY(1px) scale(.98); }
    .pick.pink{ background: var(--pink); }
    .pick.yellow{ background: var(--yellow); }
    .pick.blue{ background: var(--blue); }

    .caret{
      position: fixed;
      z-index: 9998;
      width: 10px; height: 10px;
      background: rgba(23,26,33,.92);
      border-left: 1px solid rgba(255,255,255,.12);
      border-top: 1px solid rgba(255,255,255,.12);
      transform: rotate(45deg);
      display:none;
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .caret.show{ display:block; }

    /* ===== 日記 ===== */
    .diary{
      margin-top: 12px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      display:none;
    }
    .diary.show{ display:block; }

    .diaryHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .diaryHeadLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .diaryStamp{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid var(--ring);
      background: transparent;
      flex: 0 0 auto;
    }
    .diaryStamp.filled{ border-color: rgba(255,255,255,.18); box-shadow: 0 8px 18px rgba(0,0,0,.25); }
    .diaryStamp.pink{ background: var(--pink); }
    .diaryStamp.yellow{ background: var(--yellow); }
    .diaryStamp.blue{ background: var(--blue); }

    .diaryLabel{
      font-size: 12px;
      color: var(--muted);
    }
    .diaryDate{
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .02em;
      margin-top: 2px;
    }

    .section{
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .section:first-of-type{
      margin-top: 6px;
      padding-top: 0;
      border-top: none;
    }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .sectionTitle{
      font-size: 12px;
      color: var(--muted);
    }

    input.goal{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-size: 16px; /* 大きめ */
    }
    input.goal:focus{ border-color: rgba(255,255,255,.22); }

    /* TODO */
    .todoList{ display:flex; flex-direction:column; gap: 8px; }
    .todoRow{
      display:flex;
      align-items:center;
      gap: 10px;
      position: relative;
      padding-right: 34px; /* -ボタン分の余白 */
    }
    .todoRow input[type="checkbox"]{
      width: 18px; height: 18px;
      accent-color: rgba(255,255,255,.65);
      flex: 0 0 auto;
    }
    .todoRow input.todoText{
      flex: 1 1 auto;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    .todoRow input.todoText:focus{ border-color: rgba(255,255,255,.22); }

    /* 入力中に出る - ボタン */
    .todoDel{
      position:absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      display:none;
      cursor:pointer;
    }
    .todoRow.showDel .todoDel{ display:block; }
    .todoDel:active{ transform: translateY(-50%) translateY(1px); }

    textarea.memo{
      width: 100%;
      min-height: 140px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
      resize: vertical;
      line-height: 1.5;
      font-size: 14px;
    }
    textarea.memo:focus{ border-color: rgba(255,255,255,.22); }

    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.6;
    }

    @media (max-width: 360px){
      .cell{ height: 58px; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="titleRow">
      <div>
        <h1>2026年1月</h1>
        <div class="sub">丸タップで色 / 日付タップで日記</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="small" id="resetMonth" type="button">今月リセット</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="dow">
    <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
  </div>

  <section class="grid" aria-label="2026年1月カレンダー">
    <div class="days" id="days"></div>
  </section>

  <section class="diary" id="diary">
    <div class="diaryHead">
      <div class="diaryHeadLeft">
        <div class="diaryStamp" id="diaryStamp" aria-label="その日のスタンプ"></div>
        <div>
          <div class="diaryLabel">日記</div>
          <div class="diaryDate" id="diaryDate">----</div>
        </div>
      </div>
      <button class="small" id="resetDay" type="button">この日を消す</button>
    </div>

    <!-- ① 目標 -->
    <div class="section">
      <div class="sectionHead">
        <div class="sectionTitle">① 今日の目標</div>
      </div>
      <input class="goal" id="goalInput" type="text" placeholder="1行で入力（自動保存）" />
    </div>

    <!-- ② TODO -->
    <div class="section">
      <div class="sectionHead">
        <div class="sectionTitle">② TODO</div>
        <button class="small" id="addTodo" type="button">＋</button>
      </div>
      <div class="todoList" id="todoList"></div>
    </div>

    <!-- ③ 自由メモ -->
    <div class="section">
      <div class="sectionHead">
        <div class="sectionTitle">③ 自由メモ</div>
      </div>
      <textarea class="memo" id="memoInput" placeholder="数行メモ（自動保存）"></textarea>
    </div>

    <div class="hint">
      TODOや項目は後から追加できるよう、保存形式は拡張前提。
    </div>
  </section>
</main>

<!-- 色選択ポップアップ -->
<div class="picker" id="picker" role="dialog" aria-label="色を選ぶ">
  <button class="pick pink" data-color="pink" type="button" aria-label="ピンク"></button>
  <button class="pick yellow" data-color="yellow" type="button" aria-label="黄色"></button>
  <button class="pick blue" data-color="blue" type="button" aria-label="水色"></button>
</div>
<div class="caret" id="caret"></div>

<script>
(() => {
  // ===== 固定（2026年1月） =====
  const YEAR = 2026;
  const MONTH = 1;
  const STORAGE_KEY = `sticker-cal:${YEAR}-${String(MONTH).padStart(2,'0')}`;
  const COLORS = ["pink","yellow","blue"];

  // ===== 要素 =====
  const daysEl = document.getElementById("days");

  const diaryEl = document.getElementById("diary");
  const diaryDateEl = document.getElementById("diaryDate");
  const diaryStampEl = document.getElementById("diaryStamp");
  const goalInput = document.getElementById("goalInput");
  const memoInput = document.getElementById("memoInput");

  const todoListEl = document.getElementById("todoList");
  const addTodoBtn = document.getElementById("addTodo");

  const resetMonthBtn = document.getElementById("resetMonth");
  const resetDayBtn = document.getElementById("resetDay");

  const pickerEl = document.getElementById("picker");
  const caretEl = document.getElementById("caret");

  // ===== 保存データ（拡張しやすい形） =====
  // state = {
  //   "YYYY-MM-DD": {
  //     stamp: "pink"|"yellow"|"blue"|null,
  //     diary: {
  //       goal: string,
  //       todos: Array<{ id: string, done: boolean, text: string }>,
  //       memo: string
  //     }
  //   }
  // }
  function loadState(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  let state = loadState();
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function uid(){
    // 衝突しにくい簡易ID
    return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
  }

  function ensureDay(key){
    if (!state[key]) state[key] = { stamp: null, diary: { goal:"", todos: [], memo:"" } };
    if (!state[key].diary) state[key].diary = { goal:"", todos: [], memo:"" };

    const d = state[key].diary;
    if (typeof d.goal !== "string") d.goal = "";
    if (!Array.isArray(d.todos)) d.todos = [];
    if (typeof d.memo !== "string") d.memo = "";

    // 初期TODO3行（空で）
    if (d.todos.length === 0){
      d.todos = [
        { id: uid(), done:false, text:"" },
        { id: uid(), done:false, text:"" },
        { id: uid(), done:false, text:"" },
      ];
    } else {
      // 既存要素の整形
      d.todos = d.todos.map(t => ({
        id: (t && typeof t.id === "string") ? t.id : uid(),
        done: !!(t && t.done),
        text: (t && typeof t.text === "string") ? t.text : ""
      }));
    }
  }

  // ===== 日付計算 =====
  const first = new Date(YEAR, MONTH - 1, 1);
  const last = new Date(YEAR, MONTH, 0);
  const firstDow = first.getDay();
  const daysInMonth = last.getDate();
  const totalCells = 42;

  function ymd(day){
    return `${YEAR}-${String(MONTH).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
  }

  // ===== UI 状態 =====
  let selectedDate = null;
  let pickerDate = null;

  function hidePicker(){
    pickerEl.classList.remove("show");
    caretEl.classList.remove("show");
    pickerDate = null;
  }

  function showPickerNear(dotEl, dateKey){
    pickerDate = dateKey;

    pickerEl.classList.add("show");
    caretEl.classList.add("show");

    const r = dotEl.getBoundingClientRect();
    const pr = pickerEl.getBoundingClientRect();
    const caretSize = 10;

    let left = r.left + r.width/2 - pr.width/2;
    left = Math.max(8, Math.min(left, window.innerWidth - pr.width - 8));

    let top = r.top - pr.height - 12;
    let caretTop = r.top - caretSize/2 - 6;

    if (top < 8){
      top = r.bottom + 12;
      caretTop = r.bottom + 6;
    }

    pickerEl.style.left = `${left}px`;
    pickerEl.style.top = `${top}px`;

    const caretLeft = r.left + r.width/2 - caretSize/2;
    caretEl.style.left = `${caretLeft}px`;
    caretEl.style.top = `${caretTop}px`;
  }

  function setDiaryStampFromDate(dateKey){
    ensureDay(dateKey);
    const stamp = state[dateKey].stamp;

    diaryStampEl.className = "diaryStamp";
    if (COLORS.includes(stamp)){
      diaryStampEl.classList.add("filled", stamp);
    }
  }

  // ===== 日記表示＆描画 =====
  function openDiary(dateKey){
    selectedDate = dateKey;
    ensureDay(dateKey);
    saveState(); // 初期生成を確実に保存

    diaryEl.classList.add("show");
    diaryDateEl.textContent = dateKey;
    setDiaryStampFromDate(dateKey);

    const d = state[dateKey].diary;
    goalInput.value = d.goal || "";
    memoInput.value = d.memo || "";
    renderTodos(dateKey);

    renderCalendar(); // 選択枠更新
  }

  function renderTodos(dateKey){
    ensureDay(dateKey);
    const todos = state[dateKey].diary.todos;

    todoListEl.innerHTML = "";
    for (const t of todos){
      const row = document.createElement("div");
      row.className = "todoRow";
      row.dataset.todoId = t.id;

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.checked = !!t.done;

      const txt = document.createElement("input");
      txt.type = "text";
      txt.className = "todoText";
      txt.value = t.text || "";
      txt.placeholder = "TODO";

      const del = document.createElement("button");
      del.type = "button";
      del.className = "todoDel";
      del.textContent = "－";
      del.setAttribute("aria-label", "この行を削除");

      // 入力中に - を出す
      txt.addEventListener("focus", () => row.classList.add("showDel"));
      txt.addEventListener("blur", () => {
        // クリックで - を押す瞬間に消えないよう少し遅らせる
        setTimeout(() => row.classList.remove("showDel"), 120);
      });

      // 保存
      chk.addEventListener("change", () => {
        if (!selectedDate) return;
        const dd = state[selectedDate].diary;
        const item = dd.todos.find(x => x.id === t.id);
        if (!item) return;
        item.done = chk.checked;
        saveState();
      });

      txt.addEventListener("input", () => {
        if (!selectedDate) return;
        const dd = state[selectedDate].diary;
        const item = dd.todos.find(x => x.id === t.id);
        if (!item) return;
        item.text = txt.value || "";
        saveState();
      });

      // 削除
      del.addEventListener("click", () => {
        if (!selectedDate) return;
        const dd = state[selectedDate].diary;
        dd.todos = dd.todos.filter(x => x.id !== t.id);
        // 0行は避けたいなら最低1行残す、などもできる。今は自由に0でもOK。
        if (dd.todos.length === 0){
          dd.todos = [{ id: uid(), done:false, text:"" }];
        }
        saveState();
        renderTodos(selectedDate);
      });

      row.appendChild(chk);
      row.appendChild(txt);
      row.appendChild(del);
      todoListEl.appendChild(row);
    }
  }

  // 目標・メモ：自動保存
  goalInput.addEventListener("input", () => {
    if (!selectedDate) return;
    ensureDay(selectedDate);
    state[selectedDate].diary.goal = goalInput.value || "";
    saveState();
  });
  memoInput.addEventListener("input", () => {
    if (!selectedDate) return;
    ensureDay(selectedDate);
    state[selectedDate].diary.memo = memoInput.value || "";
    saveState();
  });

  // TODO追加
  addTodoBtn.addEventListener("click", () => {
    if (!selectedDate) return;
    ensureDay(selectedDate);
    state[selectedDate].diary.todos.push({ id: uid(), done:false, text:"" });
    saveState();
    renderTodos(selectedDate);
    // 追加した行にフォーカス
    const lastRow = todoListEl.lastElementChild;
    const input = lastRow?.querySelector("input.todoText");
    input?.focus();
  });

  // ===== カレンダー描画 =====
  function renderCalendar(){
    daysEl.innerHTML = "";

    for (let i=0; i<totalCells; i++){
      const day = i - firstDow + 1;
      const inMonth = day >= 1 && day <= daysInMonth;

      const cell = document.createElement("div");
      cell.className = "cell" + (inMonth ? "" : " empty");

      const num = document.createElement("div");
      num.className = "daynum";
      num.textContent = inMonth ? String(day) : "";
      cell.appendChild(num);

      if (inMonth){
        const key = ymd(day);
        ensureDay(key);

        if (key === selectedDate) cell.classList.add("selected");

        // 日付クリック → 日記
        cell.addEventListener("click", () => {
          hidePicker();
          openDiary(key);
        });

        // スタンプ丸
        const dot = document.createElement("button");
        dot.type = "button";
        dot.className = "dot";
        dot.setAttribute("aria-label", `${key} スタンプ`);

        const stamp = state[key].stamp;
        if (COLORS.includes(stamp)){
          dot.classList.add("filled", stamp);
        }

        // dotクリックは日付クリックに伝播させない
        dot.addEventListener("click", (e) => {
          e.stopPropagation();
          if (pickerEl.classList.contains("show") && pickerDate === key){
            hidePicker();
          } else {
            showPickerNear(dot, key);
          }
        });

        cell.appendChild(dot);
      }

      daysEl.appendChild(cell);
    }
  }

  // ===== ピッカーで色選択 =====
  pickerEl.addEventListener("click", (e) => {
    const b = e.target.closest("button[data-color]");
    if (!b || !pickerDate) return;

    const color = b.getAttribute("data-color");
    ensureDay(pickerDate);

    // 同色で消す
    state[pickerDate].stamp = (state[pickerDate].stamp === color) ? null : color;

    saveState();
    hidePicker();

    // カレンダー更新
    renderCalendar();

    // 日記が開いてる日なら、日記ヘッダの丸も即反映
    if (selectedDate === pickerDate){
      setDiaryStampFromDate(selectedDate);
    }
  });

  // 外側タップでピッカー閉じる
  document.addEventListener("pointerdown", (e) => {
    const inPicker = e.target.closest("#picker");
    const isDot = e.target.closest(".dot");
    if (!inPicker && !isDot) hidePicker();
  });

  // ===== リセット =====
  resetMonthBtn.addEventListener("click", () => {
    state = {};
    saveState();
    selectedDate = null;
    hidePicker();
    diaryEl.classList.remove("show");
    renderCalendar();
  });

  resetDayBtn.addEventListener("click", () => {
    if (!selectedDate) return;
    delete state[selectedDate];
    saveState();
    // 開いたまま初期化して表示
    openDiary(selectedDate);
    renderCalendar();
  });

  // ===== 初期描画 =====
  renderCalendar();
})();
</script>
</body>
</html>
